<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مولد أداة استخراج روابط Drive</title>
    <style>
        body { font-family: system-ui, sans-serif; background-color: #f0f2f5; color: #333; text-align: center; padding: 20px; line-height: 1.6; }
        .container { max-width: 700px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h1 { color: #1a73e8; }
        p.intro { font-size: 1.1em; color: #5f6368; }
        .input-section { margin: 30px 0; }
        input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            text-align: left;
            direction: ltr;
            transition: border-color 0.3s;
        }
        input[type="url"]:focus { border-color: #1a73e8; outline: none; }
        #tool-container { margin-top: 25px; padding: 20px; border-radius: 10px; background-color: #fce8e6; display: none; }
        #tool-container p { font-weight: bold; }
        #generated-tool {
            display: inline-block;
            padding: 12px 25px;
            background-color: #d93025;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        #generated-tool:hover { background-color: #c5221f; }
    </style>
</head>
<body>
    <div class="container">
        <h1>مولد أداة استخراج الروابط</h1>
        <p class="intro">
            بسبب قوانين أمان المتصفح، لا يمكن استخراج الروابط مباشرة من هذه الصفحة.
            <br>
            لكن، يمكننا هنا بناء **"أداة استخراج مخصصة"** لكل رابط.
        </p>

        <div class="input-section">
            <label for="gdrive-url" style="font-weight: bold; display: block; margin-bottom: 10px;">الخطوة 1: الصق رابط Google Drive هنا</label>
            <input type="url" id="gdrive-url" placeholder="https://drive.google.com/file/d/..." oninput="generateTool()">
        </div>

        <div id="tool-container">
            <p>الخطوة 2: اضغط على هذا الزر لفتح الفيديو واستخراج الروابط</p>
            <a id="generated-tool" href="#" target="_blank">افتح واستخرج الروابط 🚀</a>
        </div>
    </div>

    <script>
        function generateTool() {
            const urlInput = document.getElementById('gdrive-url');
            const toolContainer = document.getElementById('tool-container');
            const generatedTool = document.getElementById('generated-tool');
            
            const gdriveUrl = urlInput.value.trim();

            if (!gdriveUrl.includes('drive.google.com/file/d/')) {
                toolContainer.style.display = 'none';
                return;
            }

            // الكود الذي سيتم تنفيذه بعد فتح صفحة جوجل درايف
            const extractionCode = `
                (function() {
                    function showResults(links) {
                        let overlay = document.getElementById('extractor-overlay-final');
                        if (overlay) overlay.remove();
                        overlay = document.createElement('div');
                        overlay.id = 'extractor-overlay-final';
                        overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.75); z-index:999999; display:flex; justify-content:center; align-items:center;';
                        const modal = document.createElement('div');
                        modal.style.cssText = 'background:white; padding:25px; border-radius:10px; width:90%; max-width:550px; font-family:sans-serif; text-align:right;';
                        let content = '<h3>لم يتم العثور على روابط.</h3><p>تأكد أن الفيديو ليس خاصًا وأن الصفحة قد تم تحميلها بالكامل.</p>';
                        if (links && links.length > 0) {
                            content = '<h3>الروابط المستخرجة بنجاح:</h3>';
                            links.forEach(link => {
                                if (link.url) {
                                    content += \`<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee; direction:ltr;">
                                        <strong>\${link.quality}p</strong>
                                        <input type="text" value="\${link.url}" readonly style="width:60%; border:1px solid #ccc; padding:5px; font-size:12px;">
                                        <button onclick="navigator.clipboard.writeText('\${link.url}').then(() => this.innerText = 'تم!')">نسخ</button>
                                    </div>\`;
                                }
                            });
                        }
                        const closeBtn = document.createElement('button');
                        closeBtn.innerText = 'إغلاق';
                        closeBtn.style.cssText = 'display:block; margin:20px auto 0 auto; padding:10px 20px; cursor:pointer; font-weight:bold;';
                        closeBtn.onclick = () => overlay.remove();
                        modal.innerHTML = content;
                        modal.appendChild(closeBtn);
                        overlay.appendChild(modal);
                        document.body.appendChild(overlay);
                    }

                    try {
                        const pageSource = document.documentElement.innerHTML;
                        const dataMatch = pageSource.match(/WIZ_global_data\\s*=\\s*({.+?});/);
                        if (!dataMatch) throw new Error('لم يتم العثور على بيانات الفيديو (WIZ_global_data).');
                        
                        const data = JSON.parse(dataMatch[1]);
                        
                        function findStreams(obj) {
                            if (typeof obj !== 'object' || obj === null) return null;
                            if (Array.isArray(obj)) {
                                const item = obj[0];
                                if (typeof item === 'object' && item !== null && typeof item['2'] === 'string' && item['2'].startsWith('http') && typeof item['4'] === 'number') {
                                    return obj;
                                }
                            }
                            for (const key in obj) {
                                const result = findStreams(obj[key]);
                                if (result) return result;
                            }
                            return null;
                        }

                        const streamData = findStreams(data);
                        if (!streamData) throw new Error('فشل البحث الذكي في العثور على الروابط داخل البيانات.');

                        const links = streamData.map(s => ({ quality: s['4'], url: s['2'] }));
                        showResults(links);
                    } catch (e) {
                        alert('خطأ: ' + e.message);
                    }
                })();
            `;

            // خدعة ذكية: نفتح رابط جوجل، وبعد 2.5 ثانية (ليكون قد تم تحميل الصفحة)، ننفذ كود الاستخراج
            const finalJsCode = `
                window.open('${gdriveUrl}', '_blank');
                alert('سيتم فتح الفيديو في تبويب جديد. بعد أن يتم تحميله بالكامل، ارجع إلى هذا التبويب واضغط "موافق" لبدء الاستخراج.');
                setTimeout(function() {
                    ${extractionCode}
                }, 2500);
            `;
            
            // هذا الكود يفتح نافذة جديدة ثم يحاول تشغيل الكود في النافذة القديمة. هذا لا يعمل جيدًا.
            // الطريقة الأبسط والأكثر ضمانًا هي العودة للـ Bookmarklet.
            // سأقوم بتغيير المنطق ليكون واضحًا للمستخدم.

            const bookmarkletCode = `javascript: ${encodeURIComponent(`(function(){${extractionCode.trim()}})()`)}`;

            // تحديث منطق الصفحة ليكون أكثر صدقًا
            generatedTool.href = bookmarkletCode;
            generatedTool.onclick = function(e) {
                e.preventDefault();
                alert('خطأ: لا يمكنك الضغط على هذا الزر مباشرة.\\n\\nالرجاء سحب هذا الزر إلى شريط الإشارات المرجعية، ثم اذهب إلى رابط الفيديو واضغط على الإشارة المرجعية هناك.');
            };

            const toolContainerText = document.querySelector('#tool-container p');
            toolContainerText.innerHTML = `الخطوة 2: الآن، <strong>اسحب هذا الزر</strong> إلى شريط الإشارات المرجعية. <br> ثم اذهب إلى رابط الفيديو واضغط على الإشارة المرجعية التي حفظتها.`;
            generatedTool.innerText = `اسحبني 🚀`;
            toolContainer.style.display = 'block';
        }
    </script>
</body>
</html>
