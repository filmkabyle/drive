<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مستخرج روابط Google Drive (الإصدار النهائي)</title>
    <style>
        body { font-family: system-ui, sans-serif; background-color: #f0f2f5; color: #1c1e21; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { width: 100%; max-width: 600px; background-color: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #0d6efd; margin-bottom: 25px; }
        input[type="url"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; text-align: left; direction: ltr; }
        button { width: 100%; padding: 12px; margin-top: 15px; background-color: #0d6efd; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        button:hover:not(:disabled) { background-color: #0b5ed7; }
        button:disabled { background-color: #6ea8fe; cursor: not-allowed; }
        .loader { text-align: center; padding: 20px; display: none; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .loader div { width: 20px; height: 20px; background-color: #0d6efd; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .loader .bounce1 { animation-delay: -0.32s; } .loader .bounce2 { animation-delay: -0.16s; }
        #results { margin-top: 25px; }
        .result-item { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .result-item .quality { font-weight: bold; background-color: #e9ecef; padding: 5px 10px; border-radius: 5px; }
        .result-item button.copy-btn { width: auto; font-size: 14px; padding: 8px 12px; background-color: #198754; color: white; }
        .result-item button.copy-btn:hover { background-color: #157347; }
        .error-message { color: #dc3545; background-color: #f8d7da; border: 1px solid #f5c2c7; padding: 15px; border-radius: 8px; text-align: center; display: none; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>مستخرج روابط Google Drive (الإصدار النهائي)</h1>
        <input type="url" id="gdrive-url" placeholder="أدخل رابط جوجل درايف هنا..." value="https://drive.google.com/file/d/14vOckU9B3fT2KbZdSGq69OxAd_ioE0da/view">
        <button id="extract-btn" onclick="extractLinks()">استخراج الروابط</button>
        <div class="loader" id="loader"> <div class="bounce1"></div> <div class="bounce2"></div> <div class="bounce3"></div> </div>
        <div id="results"></div>
        <div class="error-message" id="error-message"></div>
    </div>
    <script>
        // =================================================================
        // تم إضافة رابط تطبيق الويب الخاص بك هنا
        const YOUR_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwFQwZl6RVqO34o2aYXlPXzOVpl4rO7QzuHRm9xIEAMtYwUydtSXsirGPwoGaD7xMAm/exec';
        // =================================================================

        function findStreamData(data) { if (typeof data !== 'object' || data === null) return null; if (Array.isArray(data)) { const f = data[0]; if (Array.isArray(f) && f.length >= 3 && typeof f[0] === 'number' && typeof f[2] === 'string' && f[2].startsWith('http')) return data; } for (const k in data) { const r = findStreamData(data[k]); if (r) return r; } return null; }
        function displayResults(links) { const rDiv = document.getElementById('results'); rDiv.innerHTML = ''; if (links.length === 0) { showError("لم يتم العثور على روابط. قد يكون الفيديو قيد المعالجة."); return; } links.forEach(link => { if(!link.url) return; const item = document.createElement('div'); item.className = 'result-item'; const qSpan = document.createElement('span'); qSpan.className = 'quality'; qSpan.innerText = `${link.quality}p`; const cBtn = document.createElement('button'); cBtn.className = 'copy-btn'; cBtn.innerText = 'نسخ'; cBtn.onclick = () => { navigator.clipboard.writeText(link.url).then(() => { cBtn.innerText = 'تم النسخ!'; setTimeout(() => { cBtn.innerText = 'نسخ'; }, 2000); }); }; item.appendChild(qSpan); item.appendChild(cBtn); rDiv.appendChild(item); }); }
        function showError(msg) { const eDiv = document.getElementById('error-message'); eDiv.innerText = msg; eDiv.style.display = 'block'; }
        
        async function extractLinks() {
            const urlInput = document.getElementById('gdrive-url');
            const extractBtn = document.getElementById('extract-btn');
            const loader = document.getElementById('loader');
            const resultsDiv = document.getElementById('results');
            const errorDiv = document.getElementById('error-message');

            const gdriveUrl = urlInput.value.trim();
            if (!gdriveUrl) { alert("الرجاء إدخال رابط صالح."); return; }
            
            const fileIdMatch = gdriveUrl.match(/file\/d\/([a-zA-Z0-9_-]{28,})/);
            if (!fileIdMatch || !fileIdMatch[1]) { alert("رابط جوجل درايف غير صالح. تأكد من أنه يحتوي على 'file/d/'."); return; }
            const fileId = fileIdMatch[1];

            extractBtn.disabled = true; extractBtn.innerText = 'جاري الاستخراج...';
            loader.style.display = 'block'; resultsDiv.innerHTML = ''; errorDiv.style.display = 'none';

            try {
                const response = await fetch(`${YOUR_APPS_SCRIPT_URL}?id=${fileId}`);
                if (!response.ok) throw new Error(`فشل الاتصال بالوسيط الخاص بك. الحالة: ${response.status}`);
                
                const pageContent = await response.text();
                const match = pageContent.match(/WIZ_global_data\s*=\s*({.+?});/);
                if (!match || !match[1]) throw new Error("لم يتم العثور على متغير البيانات الرئيسي.");

                const dataObject = JSON.parse(match[1]);
                const streamData = findStreamData(dataObject);
                if (!streamData) { console.error("Data object:", dataObject); throw new Error("فشل البحث الذكي في العثور على بيانات البث."); }
                
                const videoLinks = streamData.map(s => ({ quality: s[0], type: s[1], url: s[2] }));
                displayResults(videoLinks);

            } catch (error) { console.error(error); showError(error.message);
            } finally { extractBtn.disabled = false; extractBtn.innerText = 'استخراج الروابط'; loader.style.display = 'none'; }
        }
    </script>
</body>
</html>
